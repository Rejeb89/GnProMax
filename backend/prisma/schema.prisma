generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== Organizations ==============
model Company {
  id                String   @id @default(cuid())
  name              String   @unique
  registrationNo    String?  @unique
  email             String?  @unique
  phone             String?
  website           String?
  address           String?
  city              String?
  state             String?
  postalCode        String?
  country           String?
  taxId             String?  @unique
  logoUrl           String?
  isActive          Boolean  @default(true)
  settings          Json?    @default("{}")
  
  // Relations
  branches          Branch[]
  users             User[]
  employees         Employee[]
  vehicles          Vehicle[]
  equipment         Equipment[]
  budgets           Budget[]
  expenses          Expense[]
  revenues          Revenue[]
  auditLogs         AuditLog[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("companies")
}

model Branch {
  id                String   @id @default(cuid())
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  name              String
  code              String
  phone             String?
  email             String?
  address           String?
  city              String?
  state             String?
  postalCode        String?
  country           String?
  managerName       String?
  managerPhone      String?
  isActive          Boolean  @default(true)

  // Relations
  users             UserBranch[]
  employees         Employee[]
  vehicles          Vehicle[]
  equipment         Equipment[]
  budgets           Budget[]
  expenses          Expense[]
  revenues          Revenue[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([companyId, code])
  @@map("branches")
}

// ============== Users & Auth ==============
model User {
  id                String   @id @default(cuid())
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  email             String   @unique
  username          String   @unique
  password          String
  firstName         String?
  lastName          String?
  profileImage      String?
  
  roleId            String
  role              Role     @relation(fields: [roleId], references: [id])
  
  isActive          Boolean  @default(true)
  lastLogin         DateTime?
  refreshToken      String?
  refreshTokenExpiresAt DateTime?

  // Relations
  branches          UserBranch[]
  auditLogs         AuditLog[]   @relation("UserAuditLogs")

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("users")
}

model UserBranch {
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  branchId          String
  branch            Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@id([userId, branchId])
  @@map("user_branches")
}

model Role {
  id                String   @id @default(cuid())
  name              String   @unique
  description       String?
  permissions       String[] @default([])
  isSystem          Boolean  @default(false)
  isActive          Boolean  @default(true)

  // Relations
  users             User[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("roles")
}

// ============== HR Module ==============
model Employee {
  id                String   @id @default(cuid())
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  branchId          String
  branch            Branch   @relation(fields: [branchId], references: [id])
  
  firstName         String
  lastName          String
  email             String?
  phone             String?
  employeeId        String   @unique
  designation       String?
  department        String?
  dateOfJoining     DateTime?
  dateOfBirth       DateTime?
  gender            String?   // Male, Female, Other
  maritalStatus     String?
  address           String?
  city              String?
  state             String?
  postalCode        String?
  country           String?
  profileImage      String?
  isActive          Boolean  @default(true)

  // Relations
  vehicles          Vehicle[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([companyId, employeeId])
  @@map("employees")
}

// ============== Fleet Management ==============
model Vehicle {
  id                String   @id @default(cuid())
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  branchId          String
  branch            Branch   @relation(fields: [branchId], references: [id])
  
  registrationNumber String  @unique
  vin               String?
  make              String
  model             String
  year              Int
  fuelType          String?   // Petrol, Diesel, Electric, Hybrid
  color             String?
  purchaseDate      DateTime?
  purchasePrice     Decimal?  @db.Decimal(12, 2)
  
  currentDriver     String?
  driverId          String?
  driver            Employee?  @relation(fields: [driverId], references: [id], onDelete: SetNull)
  
  mileage           Int       @default(0)
  fuelConsumption   Decimal?  @db.Decimal(5, 2)
  serviceDate       DateTime?
  insuranceExpiry   DateTime?
  
  qrCode            String?
  status            String    @default("active") // active, maintenance, inactive
  isActive          Boolean   @default(true)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("vehicles")
}

// ============== Equipment Management ==============
model Equipment {
  id                String   @id @default(cuid())
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  branchId          String
  branch            Branch   @relation(fields: [branchId], references: [id])
  
  name              String
  description       String?
  category          String
  serialNumber      String   @unique
  qrCode            String   @unique
  
  purchaseDate      DateTime?
  purchasePrice     Decimal?  @db.Decimal(12, 2)
  manufacturer      String?
  model             String?
  location          String?
  assignedTo        String?
  
  quantity          Int       @default(0)
  availableQuantity Int       @default(0)
  lowStockThreshold Int       @default(5)
  
  warrantyExpiry    DateTime?
  maintenanceDate   DateTime?
  nextMaintenanceDate DateTime?
  
  condition         String?   // good, fair, poor
  notes             String?
  
  status            String    @default("available") // available, in-use, maintenance, damaged
  
  isActive          Boolean   @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  transactions      EquipmentTransaction[]
  
  @@map("equipment")
}

model EquipmentTransaction {
  id                String   @id @default(cuid())
  equipmentId       String
  equipment         Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  
  transactionType   String    // in, out, maintenance, transfer, repair
  quantity          Int       @default(1)
  
  fromLocation      String?
  toLocation        String?
  
  notes             String?
  reference         String?
  
  createdBy         String?
  updatedBy         String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("equipment_transactions")
}

model Dispatch {
  id                String   @id @default(cuid())
  dispatchName       String
  dispatchType       String    // sent, received
  phoneNumber       String
  
  fromLocation       String?
  toLocation         String?
  equipmentName     String?
  quantity          Int?
  unit              String?
  recipient         String?
  notes             String?
  status            String    @default("PENDING") // PENDING, IN_TRANSIT, DELIVERED, CANCELLED
  
  companyId         String
  branchId          String?
  createdBy         String?
  updatedBy         String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// ============== Finance Module ==============
model Budget {
  id                String   @id @default(cuid())
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  branchId          String?
  branch            Branch?  @relation(fields: [branchId], references: [id], onDelete: SetNull)
  
  name              String
  category          String    // Operations, Marketing, HR, IT, etc.
  amount            Decimal   @db.Decimal(12, 2)
  
  fiscalYear        Int
  quarter           Int?      // 1-4
  month             Int?      // 1-12
  startDate         DateTime?
  endDate           DateTime?
  
  status            String    @default("active") // active, closed, cancelled
  notes             String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("budgets")
}

model Expense {
  id                String   @id @default(cuid())
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  branchId          String
  branch            Branch   @relation(fields: [branchId], references: [id])
  
  category          String    // Travel, Office, Utilities, Maintenance, etc.
  amount            Decimal   @db.Decimal(12, 2)
  currency          String    @default("USD")
  
  description       String
  reference         String?   // Invoice number, PO number
  
  expenseDate       DateTime
  paymentMethod     String?   // Cash, Card, Transfer
  status            String    @default("pending") // pending, approved, rejected, paid
  
  approvedBy        String?
  approvalDate      DateTime?
  
  attachment        String?
  notes             String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("expenses")
}

model Revenue {
  id                String   @id @default(cuid())
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  branchId          String
  branch            Branch   @relation(fields: [branchId], references: [id])
  
  source            String    // Product Sales, Services, Investments, etc.
  amount            Decimal   @db.Decimal(12, 2)
  currency          String    @default("USD")
  
  description       String?
  reference         String?   // Invoice number, Order number
  
  revenueDate       DateTime
  status            String    @default("pending") // pending, confirmed, received
  
  notes             String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("revenues")
}

// ============== Audit & Logging ==============
model AuditLog {
  id                String   @id @default(cuid())
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  userId            String?
  user              User?     @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: SetNull)
  
  action            String    // CREATE, UPDATE, DELETE, LOGIN, LOGOUT
  module            String    // users, equipment, finance, etc.
  resourceId        String?
  resourceType      String?
  
  oldValues         Json?
  newValues         Json?
  
  ipAddress         String?
  userAgent         String?
  status            String    @default("success") // success, failure
  statusCode        Int?
  errorMessage      String?
  
  metadata          Json?

  createdAt         DateTime @default(now())

  @@map("audit_logs")
}

// ============== System Models ==============
model RefreshToken {
  id                String   @id @default(cuid())
  userId            String
  token             String    @unique
  expiresAt         DateTime
  revokedAt         DateTime?
  
  createdAt         DateTime @default(now())

  @@map("refresh_tokens")
}
